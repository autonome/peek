# Desktop Windows Implementation Plan

## Overview
Implement desktop window management features including titlebar controls, size/position persistence, pin controls, escape behavior, and animations.

## Current Architecture
- **Window creation**: `backend/electron/ipc.ts:window-open` handler creates `BrowserWindow` instances
- **Frontend API**: `window.app.window.open(url, options)` exposed via preload
- **Window options**: `width`, `height`, `x`, `y`, `modal`, `keepLive`, `alwaysOnTop`, `resizable`, `transparent`, `frame`
- **Default**: `frame: false` (frameless windows)
- **Dragging**: `app/drag.js` - click-and-hold (300ms) then manual move via IPC
- **Settings**: `app/config.js` (core prefs), `app/settings/settings.js` (UI)
- **Animation**: `animate.js` exists but unused - window bounds animation

---

## Implementation Tasks

### 1. Title Bar Hide/Show Preference
**Files to modify:**
- `app/config.js` - Add `hideTitleBar` boolean pref (default: true)
- `app/settings/settings.js` - Pref UI is auto-generated from schema, no changes needed
- `backend/electron/ipc.ts` - Read pref when opening windows, set `frame` accordingly

**Implementation:**
```javascript
// app/config.js prefsSchema.properties
"hideTitleBar": {
  "description": "Hide window title bars by default",
  "type": "boolean",
  "default": true
}
```

In `ipc.ts:window-open`:
- Get core prefs via pubsub or direct datastore read
- Apply `frame: !hideTitleBar` unless explicitly overridden by `options.frame`

---

### 2. Titlebar Show on Hover at Top Edge
**Files to create/modify:**
- `app/titlebar-hover.js` - New file for titlebar hover detection
- `backend/electron/ipc.ts` - Add `window-set-frame` IPC handler to toggle titlebar

**Implementation:**
- Create mouse event listener that detects when cursor is at screen top edge (y < 5px)
- When hovering at top edge for 200ms, send IPC to enable frame temporarily
- When cursor moves away from titlebar area, send IPC to hide frame again
- This requires recreating the BrowserWindow or using `setAutoHideMenuBar` (limited)
- **Alternative**: Use a custom titlebar overlay instead of native frame

**Note**: Native frame cannot be toggled at runtime in Electron. Better approach:
- Always use frameless windows
- Create a custom titlebar component that shows on hover
- Implement in each window's HTML or via content script injection

---

### 3. Fix Links Opening with Titlebars
**Investigation needed:**
- In `backend/electron/main.ts:setWindowOpenHandler`, check how `window.open()` from web content works
- The handler uses `featuresMap` from window.open features string
- If no frame feature specified, it may default differently

**Fix:**
- Ensure `frame: false` is explicitly set in `setWindowOpenHandler` options (line ~844)
- Already has `...(featuresMap as Electron.BrowserWindowConstructorOptions)` - need to ensure default

---

### 4. Window Draggable API Option
**Files to modify:**
- `backend/electron/ipc.ts:window-open` - Store `draggable` param in window info
- `app/drag.js` - Check window's draggable setting before enabling drag

**Implementation:**
```javascript
// window-open options
draggable: true // default

// In drag.js, check via IPC:
const isDraggable = await window.app.invoke('window-is-draggable');
if (!isDraggable) return;
```

Add new IPC handler `window-is-draggable` that reads from window params.

---

### 5. Window Position/Size Persistence
**Files to modify:**
- `app/config.js` - Add `persistWindowState` boolean pref
- `backend/electron/ipc.ts` - Save/restore window bounds based on key/URL
- `backend/electron/datastore.ts` - Add window_state table or use extension_settings

**Implementation:**
1. Add pref `persistWindowState` (default: false)
2. When window with `persistState: true` or `key` is created, check datastore for saved bounds
3. When window is moved/resized, save bounds (debounced)
4. Store in `extension_settings` table with namespace `window_state`

```javascript
// Schema for window_state
{
  key: string,          // window key or URL hash
  x: number,
  y: number,
  width: number,
  height: number,
  lastUpdated: timestamp
}
```

Add IPC handlers:
- `window-state-save`: Save bounds for key
- `window-state-load`: Load bounds for key

Add to `window-open`:
- If `persistState: true` and key exists, load saved bounds
- On window move/resize, save (via 'moved'/'resized' events)

---

### 6. Pin Window Controls
**Files to modify:**
- `backend/electron/ipc.ts` - Add `window-set-always-on-top` IPC handler
- `extensions/cmd/` - Add pin commands

**Implementation:**
1. Add IPC handler:
```javascript
ipcMain.handle('window-set-always-on-top', async (ev, msg) => {
  const win = BrowserWindow.fromId(msg.id);
  win.setAlwaysOnTop(msg.value, msg.level || 'normal');
  // levels: 'normal', 'floating', 'torn-off-menu', 'modal-panel', 'main-menu', 'status', 'pop-up-menu', 'screen-saver'
  return { success: true };
});
```

2. Add commands:
- `pin`: Toggle always-on-top for current window
- `pin app`: Set alwaysOnTop with level 'floating' (above other app windows)
- `pin os`: Set alwaysOnTop with level 'screen-saver' (above all windows)
- `unpin`: Remove always-on-top

---

### 7. Configurable Escape Behavior
**Already implemented** in `windows.ts:addEscHandler`:
- Supports `escapeMode: 'close' | 'navigate' | 'auto'`

**Documentation needed** - Update `docs/api.md` to document this option.

**Add to window.open API** - Already works, just needs to be passed in options:
```javascript
window.app.window.open(url, { escapeMode: 'navigate' });
```

---

### 8. Window Animation API
**Files to modify:**
- `backend/electron/ipc.ts` - Add animation support to window-open and new `window-animate` handler
- Move `animate.js` logic into backend

**Implementation:**
1. Add new IPC handler `window-animate`:
```javascript
ipcMain.handle('window-animate', async (ev, msg) => {
  const { id, from, to, duration } = msg;
  const win = BrowserWindow.fromId(id);
  // Animate from {x,y,w,h} to {x,y,w,h} over duration ms
  // Use setInterval with ~10ms ticks
});
```

2. Add animation options to window-open:
```javascript
// Options
{
  animation: {
    from: { x, y, width, height },  // Start position (optional, default: edge of screen)
    duration: 150  // ms
  }
}
```

3. Frontend API wrapper:
```javascript
window.app.window.animate(windowId, { from, to, duration });
```

---

### 9. Update Slides to Use Animation
**Files to modify:**
- `extensions/slides/background.js` - Use animation API instead of direct positioning

**Implementation:**
In `executeItem()`:
```javascript
// Instead of opening at final position, open at off-screen position
// Then animate to final position
const offScreen = calculateOffScreenPosition(item.screenEdge);
const finalPos = { x, y, width, height };

const result = await api.window.open(item.address, {
  ...params,
  x: offScreen.x,
  y: offScreen.y,
  animation: {
    to: finalPos,
    duration: 150
  }
});
```

---

## Implementation Order

1. **Phase 1: Core Window Options** (Low risk, foundation)
   - Fix links opening with titlebars
   - Window draggable API option
   - Document escape behavior

2. **Phase 2: Preferences** (Medium complexity)
   - Titlebar hide/show pref
   - Window persistence pref and implementation

3. **Phase 3: Pin Controls** (Standalone feature)
   - Add IPC handler
   - Add commands

4. **Phase 4: Titlebar Hover** (Complex, may need custom solution)
   - Investigate native vs custom approach
   - Implement chosen solution

5. **Phase 5: Animation** (Standalone feature)
   - Add animation IPC handler
   - Update slides extension

---

## Testing Strategy
- Test each feature in isolation
- Test with existing extensions (slides, peeks, cmd)
- Test persistence across app restarts
- Test animation smoothness
- Test pin levels work correctly on macOS

---

## Files Summary

### New Files
- `app/titlebar-hover.js` - Titlebar hover detection (if custom approach)

### Modified Files
- `app/config.js` - Add prefs: `hideTitleBar`, `persistWindowState`
- `backend/electron/ipc.ts` - Add handlers: `window-set-always-on-top`, `window-animate`, `window-state-save`, `window-state-load`, `window-is-draggable`
- `backend/electron/main.ts` - Ensure `frame: false` default in setWindowOpenHandler
- `app/drag.js` - Check draggable param
- `extensions/slides/background.js` - Use animation API
- `extensions/cmd/commands/` - Add pin commands
- `docs/api.md` - Document new options

### Files to Remove
- `animate.js` - Logic moved to backend

<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self';">
    <title>Datastore IPC Test</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        padding: 20px;
        background: #1e1e1e;
        color: #d4d4d4;
      }
      h1 {
        color: #4ec9b0;
      }
      .test {
        margin: 10px 0;
        padding: 10px;
        background: #252526;
        border-left: 3px solid #007acc;
      }
      .test.success {
        border-left-color: #4ec9b0;
      }
      .test.error {
        border-left-color: #f48771;
      }
      pre {
        background: #1e1e1e;
        padding: 10px;
        overflow-x: auto;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>Datastore IPC Test</h1>
    <div id="results"></div>

    <script type="module">
      const results = document.getElementById('results');

      function addResult(name, success, data) {
        const div = document.createElement('div');
        div.className = `test ${success ? 'success' : 'error'}`;
        div.innerHTML = `
          <strong>${success ? '✓' : '✗'} ${name}</strong>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
        results.appendChild(div);
      }

      async function runTests() {
        try {
          // Test 1: Check if api.datastore exists
          const hasDatastore = window.api && window.api.datastore;
          addResult('API available', hasDatastore, {
            hasApi: !!window.api,
            hasDatastore: hasDatastore,
            methods: hasDatastore ? Object.keys(window.api.datastore) : []
          });

          if (!hasDatastore) {
            throw new Error('api.datastore not available');
          }

          // Test 2: Add an address
          const testUri = 'https://example.com/test';
          const addResult = await window.api.datastore.addAddress(testUri, {
            title: 'Test Address',
            mimeType: 'text/html'
          });
          addResult('Add address', addResult.success, addResult);

          const addressId = addResult.id;

          // Test 3: Get the address
          const getResult = await window.api.datastore.getAddress(addressId);
          addResult('Get address', getResult.success, getResult);

          // Test 4: Update the address
          const updateResult = await window.api.datastore.updateAddress(addressId, {
            title: 'Updated Test Address'
          });
          addResult('Update address', updateResult.success, updateResult);

          // Test 5: Query addresses
          const queryResult = await window.api.datastore.queryAddresses({});
          addResult('Query addresses', queryResult.success, {
            ...queryResult,
            count: queryResult.data ? queryResult.data.length : 0
          });

          // Test 6: Add a visit
          const visitResult = await window.api.datastore.addVisit(addressId, {
            source: 'test',
            sourceId: 'test_ipc',
            windowType: 'modal',
            duration: 5000
          });
          addResult('Add visit', visitResult.success, visitResult);

          // Test 7: Query visits
          const visitsResult = await window.api.datastore.queryVisits({});
          addResult('Query visits', visitsResult.success, {
            ...visitsResult,
            count: visitsResult.data ? visitsResult.data.length : 0
          });

          // Test 8: Get stats
          const statsResult = await window.api.datastore.getStats();
          addResult('Get stats', statsResult.success, statsResult);

          // Test 9: Add content
          const contentResult = await window.api.datastore.addContent({
            title: 'Test Note',
            content: 'This is a test note created via IPC',
            contentType: 'markdown',
            mimeType: 'text/markdown'
          });
          addResult('Add content', contentResult.success, contentResult);

          // Test 10: Get table
          const tableResult = await window.api.datastore.getTable('addresses');
          addResult('Get table', tableResult.success, {
            ...tableResult,
            rowCount: tableResult.data ? Object.keys(tableResult.data).length : 0
          });

          console.log('All tests completed!');

        } catch (error) {
          addResult('Test execution', false, {
            error: error.message,
            stack: error.stack
          });
        }
      }

      // Run tests when page loads
      runTests();
    </script>
  </body>
</html>
